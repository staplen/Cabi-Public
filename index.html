<!DOCTYPE html>
<html>
  <head>
    <title>Cabi Glance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="shortcut icon" href="img/favicon.ico" />
    <link rel="apple-touch-icon" href="img/ios/icon.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="img/ios/icon-72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="img/ios/icon@2x.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="img/ios/icon-72@2x.png" />
    
    <link href="dist/all.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript" src="//use.typekit.net/xto8xnn.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-28679304-9', 'auto');
    </script>
  </head>
  <body>

    <div id="content">
      <div id="loading">
        <i class="fa fa-spinner fa-pulse"></i>
      </div>

      <a href="#" class="overlay-btn info-btn" data-toggle="modal" data-target="#about-modal"><i class="fa fa-info-circle"></i></a>

      <!-- Modal -->
      <div class="modal fade" id="about-modal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="myModalLabel">About Cabi Glance</h4>
            </div>
            <div class="modal-body">
              <p>Use Cabi Glance when you're on the go and want to quickly check for <a href="http://www.capitalbikeshare.com/" target="_blank">Capital Bikeshare</a> bike and dock availability. Support for many more cities coming soon!</p>
              <p>Cabi Glance is made by <a href="http://nicostaple.com" target="_blank">Nico Staple</a>. Feeback welcome <a href="https://twitter.com/stapletweets" target="_blank">@StapleTweets</a> or <a href="mailto:cabi@nicostaple.com">cabi@nicostaple.com</a>. Enjoying the app and feeling generous? <a href="https://cash.me/$taple" target="_blank">https://cash.me/$taple</a></p>
            </div>
          </div>
        </div>
      </div>

      <div id="geolocation-error">
        <h1>There was an error determining your location. Please make sure location services are enabled and you've allowed Cabi to use your location information.</h1>
      </div>
      <div id="stations-list-container"></div>
    </div>

    <script>window.cabiApp = {};</script>
    <script src="api/data/js"></script>
    <script src="dist/all.js"></script>
    
    <!-- Backbone templates -->
    <script id="stations-list-template" type="text/template">
      <%
        stations.each(function(station) {
          var bikeClass = 'progress-bar-success';
          var dockClass = 'progress-bar-success';
          var updateTime = station.get('lastCommWithServer') ? new Date(parseInt(station.get('lastCommWithServer'))) : false;

          var bikePlural = parseInt(station.get('nbBikes')) === 1 ? '' : 's';
          var dockPlural = parseInt(station.get('nbEmptyDocks')) === 1 ? '' : 's';

          var intBikes = parseInt(station.get('nbBikes'));
          var intDocks = parseInt(station.get('nbEmptyDocks'));
          var totalDocks = intBikes + intDocks;

          var bikePercent = intBikes / totalDocks;
          bikePercent = Math.floor(bikePercent * 100);
          var dockPercent = intDocks / totalDocks;
          dockPercent = Math.floor(dockPercent * 100);
          var percentTotal = dockPercent + bikePercent;

          if (percentTotal !== 100) {
            if (dockPercent < bikePercent) {
              dockPercent = dockPercent + (100 - percentTotal);
            }
            else if (dockPercent > bikePercent) {
              bikePercent = bikePercent + (100 - percentTotal);
            }
          }
          
          // Set percentage min and max for bar chart display and classes for progress bars
          if (station.get('nbBikes') <= 3) {
            bikeClass = 'progress-bar-warning';
            bikePercent = 25;
            dockPercent = 75;
            if (station.get('nbBikes') == 0) {
              bikeClass = 'progress-bar-danger';
              bikePercent = 15;
              dockPercent = 85;
            }
          }
          if (station.get('nbEmptyDocks') <= 3) {
            dockClass = 'progress-bar-warning';
            bikePercent = 75;
            dockPercent = 25;
            if (station.get('nbEmptyDocks') == 0) {
              dockClass = 'progress-bar-danger';
              bikePercent = 85;
              dockPercent = 15;
            }
          }

          var progressClass = (intBikes > 0 && intDocks > 0) ? '' : ' singular';

          %>
          <div class="row station-item" id="station-<%= station.get('id') %>">
            <a href="#stations/<%= station.get('id') %>" data-id="<%= station.get('id') %>">
              <div class="col-md-12">
                <%= station.get('name') %>
                <div class="progress<%= progressClass %>">
                  <div class="progress-bar <%= bikeClass %>" style="width: <%= bikePercent %>%"><img src="/img/bike.svg" alt="" /></div>
                  <div class="progress-bar <%= dockClass %>" style="width: <%= dockPercent %>%"><i class="fa fa-arrow-circle-o-down"></i></div>
                </div>
                <div class="text">
                  <p><% if (updateTime) { %><span class="timeago" title="<%= updateTime.toISOString() %>"></span>: <% } %><strong><%= station.get('nbBikes') %> bike<%= bikePlural %></strong> and <strong><%= station.get('nbEmptyDocks') %> dock<%= dockPlural %></strong> <%= station.get('distance').toFixed(2) %> miles away</p>
                </div>
              </div><!-- END .col-md-12 -->
              <% if (station.get('locked') === 'true') { %>
                <div class="station-lock-overlay">
                  <h1>Station Closed</h1>
                </div>
              <% } %>
            </a>
          </div>
      <% }); %>
    </script>
    <script id="station-counter-template" type="text/template">
      <a id="station-list-trigger" class="overlay-btn" href="#">&larr; Station List</a>
      <% 
        var bikeClass = '';
        var dockClass = '';
        var updateTime = station.lastCommWithServer ? new Date(parseInt(station.lastCommWithServer)) : false;

        if (station.nbBikes <= 3) {
          bikeClass = ' low';
            if (station.nbBikes == 0) {
              bikeClass = ' empty';
            }
        }
        if (station.nbEmptyDocks <= 3) {
          dockClass = ' low';
            if (station.nbEmptyDocks == 0) {
              dockClass = ' empty';
            }
        }
      %>
      <div class="row-fluid num-container<%= bikeClass %>" id="num-bikes">
        <div class="span12">
          <p><%= station.nbBikes %> <img src="/img/bike.svg" alt="" /></p>
        </div>
      </div>
      <div class="row-fluid num-container<%= dockClass %>" id="num-docks">
        <div class="span12">
          <p><%= station.nbEmptyDocks %> <i class="fa fa-arrow-circle-o-down"></i></p>
        </div>
      </div>
      <div class="station-banner">
        <p><%= station.name %><br/><% if (updateTime) { %><em><span class="timeago" title="<%= updateTime.toISOString() %>"></span></em><% } %></p>
      </div>
      <% if (station.locked === 'true') { %>
        <div class="station-lock-overlay">
          <h1>Station Closed</h1>
        </div>
      <% } %>
    </script>

  </body>
</html>